<!DOCTYPE html>
<html>
<head>
    <title>Impersonation Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #0f172a;
            color: #fff;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #1e293b;
            padding: 30px;
            border-radius: 10px;
        }
        h1 {
            color: #00C7D1;
        }
        .info-block {
            background: #334155;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            border-left: 4px solid #00C7D1;
        }
        .warning {
            background: #78350f;
            border-left-color: #f59e0b;
        }
        button {
            background: #00C7D1;
            color: #000;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #00e5f0;
        }
        code {
            background: #000;
            padding: 2px 6px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Impersonation Debug Tool</h1>

        <div class="info-block">
            <h3>Current Impersonation Status:</h3>
            <div id="impersonation-status"></div>
        </div>

        <div class="info-block">
            <h3>localStorage Data:</h3>
            <pre id="localstorage-data"></pre>
        </div>

        <div class="info-block warning">
            <h3>‚ö†Ô∏è Common Issues:</h3>
            <ul>
                <li>If <code>targetUserId</code> is the same for different impersonations, the impersonation system is NOT switching users properly</li>
                <li>If you impersonate User A but see data for User B, there's a cache or context problem</li>
                <li>If the page doesn't reload after clicking "Impersonate", the context won't update</li>
            </ul>
        </div>

        <div>
            <h3>Actions:</h3>
            <button onclick="clearImpersonation()">Clear Impersonation Data</button>
            <button onclick="location.reload()">Reload Page</button>
            <button onclick="showFullLocalStorage()">Show All localStorage</button>
        </div>

        <div class="info-block" id="all-storage" style="display:none;">
            <h3>All localStorage Keys:</h3>
            <pre id="all-storage-data"></pre>
        </div>
    </div>

    <script>
        function displayImpersonationStatus() {
            const impersonationData = localStorage.getItem('impersonation');
            const statusDiv = document.getElementById('impersonation-status');

            if (!impersonationData) {
                statusDiv.innerHTML = '<p style="color: #f59e0b;">‚ùå NOT IMPERSONATING</p>';
                document.getElementById('localstorage-data').textContent = 'No impersonation data found';
                return;
            }

            try {
                const data = JSON.parse(impersonationData);
                statusDiv.innerHTML = `
                    <p style="color: #10b981;">‚úÖ IMPERSONATING</p>
                    <table style="width:100%; margin-top:10px;">
                        <tr><td><strong>Admin ID:</strong></td><td><code>${data.adminId}</code></td></tr>
                        <tr><td><strong>Admin Email:</strong></td><td><code>${data.adminEmail}</code></td></tr>
                        <tr><td><strong>Target User ID:</strong></td><td><code style="color: #00C7D1; font-size: 14px;">${data.targetUserId}</code></td></tr>
                        <tr><td><strong>Target Email:</strong></td><td><code>${data.targetUserEmail}</code></td></tr>
                        <tr><td><strong>Started:</strong></td><td>${new Date(data.timestamp).toLocaleString()}</td></tr>
                    </table>
                `;
                document.getElementById('localstorage-data').textContent = JSON.stringify(data, null, 2);
            } catch (e) {
                statusDiv.innerHTML = '<p style="color: #ef4444;">‚ùå ERROR: Invalid impersonation data</p>';
                document.getElementById('localstorage-data').textContent = impersonationData;
            }
        }

        function clearImpersonation() {
            if (confirm('Clear impersonation data and return to admin view?')) {
                localStorage.removeItem('impersonation');
                alert('Impersonation data cleared! The page will reload.');
                location.reload();
            }
        }

        function showFullLocalStorage() {
            const allData = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                allData[key] = localStorage.getItem(key);
            }
            document.getElementById('all-storage-data').textContent = JSON.stringify(allData, null, 2);
            document.getElementById('all-storage').style.display = 'block';
        }

        // Display on load
        displayImpersonationStatus();

        // Refresh every 2 seconds to catch changes
        setInterval(displayImpersonationStatus, 2000);
    </script>
</body>
</html>
